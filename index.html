<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OMNIFIT Widget V3</title>

<style>
:root{
  --sage-light:#E6F0D8;
  --sage-mid:#BFD4A5;
  --sage-dark:#8BB076;
  --card:#FFFFFF;
  --border:#DCE7FF;
  --ink:#111;
  --muted:#475569;
  --frame-bg:#E8E6E6;
}

html,body{
  margin:0; padding:0;
  background:var(--frame-bg);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
body{
  display:flex; justify-content:center;
  padding:12px; overflow-x:hidden;
}

#wrap{
  width:640px; max-width:640px;
  background:var(--card);
  border-radius:16px;
  border:1.5px solid var(--border);
  box-shadow:0 8px 24px rgba(0,0,0,0.05);
  padding:20px; box-sizing:border-box;
  transform-origin:top center;
}

/* Header */
.header-nav{
  display:flex; justify-content:center;
  gap:28px; margin-bottom:8px;
}
.nav-btn{
  width:32px; height:32px;
  border-radius:8px;
  border:1.5px solid var(--border);
  background:white; font-size:18px;
  cursor:pointer; transition:.2s;
}
.nav-btn:disabled{ opacity:.4; cursor:not-allowed; }

#headerTitle{
  text-align:center;
  font-weight:700;
  font-size:20px;
  color:var(--ink);
  margin-bottom:12px;
}

/* Heatmap */
#heatmapContainer{
  display:flex; flex-direction:column;
  gap:6px; margin-bottom:18px;
}
.hm-row{
  display:flex; gap:4px; align-items:center;
}
.hm-label{
  width:32px; text-align:right;
  font-size:12px; font-weight:600;
  color:var(--muted);
  padding-right:4px;
}
.hm-month-label{
  text-align:center;
  font-size:12px;
  margin-bottom:4px;
  color:var(--muted);
  font-weight:600;
}
.hm-cell{
  width:14px; height:14px;
  border-radius:4px;
  background:#F2F2F2;
}

/* Tabs — DAILY REMOVED */
#tabs{
  display:flex; justify-content:space-between;
  margin-bottom:14px;
}
.tab{
  flex:1; text-align:center;
  padding:6px 8px; margin:0 4px;
  border-radius:999px; border:1.5px solid var(--border);
  background:#fff; color:var(--muted);
  font-weight:600; cursor:pointer; user-select:none;
  transition:all .2s;
}
.tab.active{
  background:var(--sage-light);
  color:var(--ink);
  border-color:var(--sage-light);
}

/* Content */
#contentCard{
  background:white;
  border-radius:14px;
  border:1.5px solid #E0E6E2;
  box-shadow:0 8px 24px rgba(0,0,0,0.05);
  padding:16px;
  max-height:58vh; overflow-y:auto;
  position:relative;
}

.checkmark{
  position:absolute;
  bottom:14px; right:14px;
  width:24px; height:24px;
  border-radius:6px;
  border:2px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; background:#fff;
  transition:.15s;
}
.checkmark.checked{
  background:var(--sage-light);
  border-color:var(--sage-dark);
}
.checkmark.checked::after{
  content:"✓"; color:var(--sage-dark);
  font-weight:700;
}
</style>
</head>

<body>
<div id="wrap">

  <!-- NAV -->
  <div class="header-nav">
    <button id="prevBtn" class="nav-btn">←</button>
    <button id="nextBtn" class="nav-btn">→</button>
  </div>

  <!-- DAY -->
  <div id="headerTitle">Loading…</div>

  <!-- HEATMAP -->
  <div id="heatmapContainer"></div>

  <!-- TABS (ONLY MICRO + MOTIVATION) -->
  <div id="tabs">
    <div class="tab active" data-tab="micro">Micro Exercise</div>
    <div class="tab" data-tab="motivation">Motivation</div>
  </div>

  <!-- CONTENT -->
  <div id="contentCard"></div>

</div>

<script>
/* ========== CONFIG ========== */
const JSON_URL = "./omnifit_data.json";

let DAYS = [];
let index = 0;
let activeTab = "micro";

/* Local keys */
const KEY_MICRO = d => `omni_micro_${d}`;
const KEY_MOTIV = d => `omni_motiv_${d}`;

/* Load JSON */
fetch(JSON_URL)
  .then(r=>r.json())
  .then(data=>{
    DAYS = data;
    index = findTodayIndex();
    buildHeatmap();
    render();
  })
  .catch(err=>console.error("JSON ERROR:",err));

function findTodayIndex(){
  const iso = new Date().toISOString().slice(0,10);
  const i = DAYS.findIndex(d=>d.date===iso);
  return i>=0 ? i : DAYS.length-1;
}

function calcDayNumber(dateStr){
  const epoch = new Date("2024-05-13");
  const d = new Date(dateStr);
  return Math.floor((d-epoch)/86400000)+1;
}

function formatText(t){
  if(!t) return "";
  return t
    .replace(/(https?:\/\/[^\s]+)/g, u =>
      `<a href="${u}" target="_blank" style="color:#2a6; text-decoration:underline;">${u}</a>`
    )
    .replace(/\n/g,"<br>");
}

function isMicroDone(d){ return localStorage.getItem(KEY_MICRO(d))==="1"; }
function isMotivDone(d){ return localStorage.getItem(KEY_MOTIV(d))==="1"; }

/* HEATMAP */
function buildHeatmap(){
  const wrap = document.querySelector("#heatmapContainer");
  wrap.innerHTML = "";

  const WEEKS = 12;
  const ROWS = ["Sun","Tue","Fri","Sat"];

  const monthLabel=document.createElement("div");
  monthLabel.className="hm-month-label";
  monthLabel.textContent = getMonthLabel();
  wrap.appendChild(monthLabel);

  ROWS.forEach(rowName=>{
    const row=document.createElement("div");
    row.className="hm-row";

    const label=document.createElement("div");
    label.className="hm-label";
    label.textContent=rowName;
    row.appendChild(label);

    for(let w=0; w<WEEKS; w++){
      const cell=document.createElement("div");
      cell.className="hm-cell";
      cell.dataset.week=w;
      cell.dataset.row=rowName;
      row.appendChild(cell);
    }

    wrap.appendChild(row);
  });

  updateHeatmap();
}

function getMonthLabel(){
  const d = DAYS[index];
  return new Date(d.date).toLocaleString("en",{month:"long"});
}

function updateHeatmap(){
  const cells=document.querySelectorAll(".hm-cell");
  const visible = DAYS.slice(-84);

  cells.forEach((c,i)=>{
    const d = visible[i];
    if(!d){ c.style.background="#F2F2F2"; return; }

    const score =
      (isMicroDone(d.date)?1:0) +
      (isMotivDone(d.date)?1:0);

    if(score===0) c.style.background="#F2F2F2";
    if(score===1) c.style.background="var(--sage-light)";
    if(score===2) c.style.background="var(--sage-mid)";
  });
}

/* TABS */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    const next = tab.dataset.tab;
    if(next!==activeTab){
      activeTab=next;
      render();
    }
  });
});

/* CONTENT RENDER */
function buildContent(){
  const d=DAYS[index];

  if(activeTab==="micro"){
    return `
      <h3>Micro Daily Exercise</h3>
      <div>${formatText(d.micro_exercise)}</div>
      <div class="checkmark ${isMicroDone(d.date)?"checked":""}"
           onclick="toggleMicro('${d.date}')"></div>`;
  }

  return `
    <h3>Motivation</h3>
    <div>${formatText(d.motivation)}</div>
    <div class="checkmark ${isMotivDone(d.date)?"checked":""}"
         onclick="toggleMotiv('${d.date}')"></div>`;
}

function toggleMicro(date){
  const v=!isMicroDone(date);
  localStorage.setItem(KEY_MICRO(date),v?"1":"0");
  updateHeatmap(); render();
}
function toggleMotiv(date){
  const v=!isMotivDone(date);
  localStorage.setItem(KEY_MOTIV(date),v?"1":"0");
  updateHeatmap(); render();
}

/* NAV */
document.querySelector("#prevBtn").onclick=()=>{
  if(index>0){ index--; render(); }
};
document.querySelector("#nextBtn").onclick=()=>{
  if(index<DAYS.length-1){ index++; render(); }
};

function render(){
  const d=DAYS[index];
  document.querySelector("#headerTitle").textContent =
    `Day ${calcDayNumber(d.date)} | ${d.day_type}`;

  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active",t.dataset.tab===activeTab);
  });

  document.querySelector("#contentCard").innerHTML=buildContent();
}
</script>

</body>
</html>
