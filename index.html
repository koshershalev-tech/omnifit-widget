<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OMNIFIT Widget V2</title>

<style>
:root{
  --sage-light:#E6F0D8;
  --sage-mid:#BFD4A5;
  --sage-dark:#8BB076;
  --border:#DCE7FF;
  --ink:#111;
  --muted:#475569;
  --card:#FFFFFF;
  --frame-bg:#E8E6E6;
}

/* page base */
html,body{
  margin:0; padding:0;
  background:var(--frame-bg);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
body{
  display:flex;
  justify-content:center;
  padding:12px;
  overflow-x:hidden;
}

/* wrapper */
#wrap{
  width:640px; max-width:640px;
  background:var(--card);
  border-radius:16px;
  border:1.5px solid var(--border);
  box-shadow:0 8px 24px rgba(0,0,0,0.05);
  padding:20px;
  box-sizing:border-box;
  transform-origin:top center;
}

/* header */
#headerTitle{
  text-align:center;
  font-weight:700;
  font-size:20px;
  color:var(--ink);
  margin-bottom:12px;
}

/* heatmap */
#heatmap{
  display:grid;
  grid-template-rows:repeat(4, 1fr);
  grid-auto-flow:column;
  gap:3px;
  margin:0 auto 16px auto;
  width:max-content;
}
.hm-cell{
  width:14px; height:14px;
  border-radius:3px;
  background:#F2F2F2;
}

/* tab bar */
#tabs{
  display:flex;
  justify-content:space-between;
  margin-bottom:14px;
}
.tab{
  flex:1;
  text-align:center;
  padding:6px 8px;
  margin:0 4px;
  border-radius:999px;
  border:1.5px solid var(--border);
  background:#fff;
  color:var(--muted);
  font-weight:600;
  cursor:pointer;
  user-select:none;
  transition:all .2s;
}
.tab.active{
  background:var(--sage-light);
  color:var(--ink);
  border-color:var(--sage-light);
}

/* content card */
#contentCard{
  background:white;
  border-radius:14px;
  border:1.5px solid #E0E6E2;
  box-shadow:0 8px 24px rgba(0,0,0,0.05);
  padding:16px;
  max-height:58vh;
  overflow-y:auto;
  position:relative;
}

/* slide animation */
.slide-enter{
  opacity:0;
  transform:translateX(20px);
}
.slide-enter-active{
  opacity:1;
  transform:translateX(0);
  transition:all .2s ease-out;
}
.slide-exit{
  opacity:1;
  transform:translateX(0);
}
.slide-exit-active{
  opacity:0;
  transform:translateX(-20px);
  transition:all .2s ease-out;
}

/* checkmark */
.checkmark{
  position:absolute;
  bottom:14px; right:14px;
  width:24px; height:24px;
  border-radius:6px;
  border:2px solid var(--border);
  display:flex;
  align-items:center; justify-content:center;
  cursor:pointer;
  background:#fff;
  transition:.15s;
}
.checkmark.checked{
  background:var(--sage-light);
  border-color:var(--sage-dark);
}
.checkmark.checked::after{
  content:"✓";
  color:var(--sage-dark);
  font-weight:700;
}

/* header arrows */
.header-nav{
  display:flex;
  justify-content:center;
  gap:28px;
  margin-bottom:8px;
}
.nav-btn{
  width:32px; height:32px;
  border-radius:8px;
  border:1.5px solid var(--border);
  background:white;
  font-size:18px;
  cursor:pointer;
  transition:.2s;
}
.nav-btn:disabled{
  opacity:.4; cursor:not-allowed;
}

/* mobile */
@media(max-width:480px){
  #wrap{
    border-radius:12px;
    padding:14px;
  }
  .tab{ font-size:14px; padding:6px 4px; }
  #contentCard{ max-height:60vh; }
  .hm-cell{ width:12px; height:12px; }
}

</style>
</head>

<body>
<div id="wrap">

  <!-- HEADER NAV -->
  <div class="header-nav">
    <button id="prevBtn" class="nav-btn">←</button>
    <button id="nextBtn" class="nav-btn">→</button>
  </div>

  <!-- DAY + TAG -->
  <div id="headerTitle">Loading…</div>

  <!-- HEATMAP -->
  <div id="heatmap"></div>

  <!-- TAB BAR -->
  <div id="tabs">
    <div class="tab active" data-tab="micro">Micro Exercise</div>
    <div class="tab" data-tab="daily">Omnifit Daily</div>
    <div class="tab" data-tab="motivation">Motivation</div>
  </div>

  <!-- CONTENT -->
  <div id="contentCard"></div>

</div>

<script>
/* ==========================
      CONFIG + STATE
========================== */
const CSV_URL = "./omnifit_data.csv";

let DAYS = [];
let index = 0;
let activeTab = "micro";

/* storage keys */
const KEY_MICRO = date => `omni_micro_${date}`;
const KEY_MOTIV = date => `omni_motiv_${date}`;

/* ==========================
      INITIALIZATION
========================== */
fetch(CSV_URL)
  .then(r=>r.text())
  .then(csvText=>parseCSV(csvText))
  .then(rows=>{
    DAYS = rows;
    index = findTodayIndex();
    buildHeatmap();
    render();
  })
  .catch(err=>{
    console.error("CSV ERROR",err);
  });

/* ==========================
      CSV PARSER
========================== */
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  const header = lines[0].split(",").map(x=>x.trim().toLowerCase());
  const idx = key => header.indexOf(key);

  return lines.slice(1).map(line=>{
    const row = splitCSVLine(line);
    return {
      date: row[idx("date")],
      day_type: row[idx("day_type")],
      micro: row[idx("micro_exercise")],
      daily: row[idx("daily_exercise")],
      motivation: row[idx("motivation")]
    };
  });
}
function splitCSVLine(line){
  const out=[], cell=[], chars=[...line];
  let inQ=false;
  for(let i=0;i<chars.length;i++){
    const c=chars[i];
    if(c=='"'){
      if(inQ && chars[i+1]=='"'){ cell.push('"'); i++; }
      else inQ=!inQ;
    } else if(c=="," && !inQ){
      out.push(cell.join("")); cell.length=0;
    } else cell.push(c);
  }
  out.push(cell.join(""));
  return out;
}

/* ==========================
      TODAY INDEX
========================== */
function findTodayIndex(){
  const iso = new Date().toISOString().slice(0,10);
  const found = DAYS.findIndex(d=>d.date===iso);
  return found>=0 ? found : DAYS.length-1;
}

/* ==========================
      HEADER RENDER
========================== */
function renderHeader(){
  const d = DAYS[index];
  document.querySelector("#headerTitle").textContent =
    `Day ${calcDayNumber(d.date)} | ${d.day_type}`;
}
function calcDayNumber(dateStr){
  const epoch = new Date("2024-05-13");
  const day = new Date(dateStr);
  return Math.floor((day-epoch)/86400000) + 1;
}

/* ==========================
      TAB BAR EVENTS
========================== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    const newTab = tab.dataset.tab;
    if(newTab!==activeTab){
      activeTab=newTab;
      updateTabs();
      slideContent();
    }
  });
});
function updateTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab===activeTab);
  });
}

/* ==========================
      CONTENT RENDER
========================== */
function slideContent(){
  const card = document.querySelector("#contentCard");
  const old = card.innerHTML;

  /* exit animation */
  card.classList.add("slide-exit");
  card.classList.add("slide-exit-active");

  setTimeout(()=>{
    card.innerHTML = buildContent();
    card.classList.remove("slide-exit","slide-exit-active");
    card.classList.add("slide-enter");

    setTimeout(()=>{
      card.classList.remove("slide-enter","slide-enter-active");
    },200);
  },180);

  setTimeout(()=>card.classList.add("slide-enter-active"),20);
}

function buildContent(){
  const d = DAYS[index];
  if(activeTab==="micro"){
    return `
      <h3>Micro Daily Exercise</h3>
      <div>${formatText(d.micro)}</div>
      <div class="checkmark ${isMicroDone(d.date)?"checked":""}" 
           onclick="toggleMicro('${d.date}')"></div>
    `;
  }
  if(activeTab==="daily"){
    return `
      <h3>Omnifit Daily</h3>
      <div>${formatText(d.daily)}</div>
    `;
  }
  if(activeTab==="motivation"){
    return `
      <h3>Motivation</h3>
      <div>${formatText(d.motivation)}</div>
      <div class="checkmark ${isMotivDone(d.date)?"checked":""}"
           onclick="toggleMotiv('${d.date}')"></div>
    `;
  }
}

/* formatting */
function formatText(t){
  if(!t) return "";
  return t.replace(/\n/g,"<br>");
}

/* ==========================
      LOCAL STORAGE
========================== */
function isMicroDone(date){ return localStorage.getItem(KEY_MICRO(date))==="1"; }
function isMotivDone(date){ return localStorage.getItem(KEY_MOTIV(date))==="1"; }

function toggleMicro(date){
  const done = !isMicroDone(date);
  localStorage.setItem(KEY_MICRO(date), done?"1":"0");
  updateHeatmap();
  slideContent();
}
function toggleMotiv(date){
  const done = !isMotivDone(date);
  localStorage.setItem(KEY_MOTIV(date), done?"1":"0");
  updateHeatmap();
  slideContent();
}

/* ==========================
      HEATMAP
========================== */
function buildHeatmap(){
  const hm = document.querySelector("#heatmap");
  hm.innerHTML="";

  const total = Math.min(28, DAYS.length);
  const recent = DAYS.slice(-total);

  recent.forEach(d=>{
    const cell=document.createElement("div");
    cell.className="hm-cell";
    cell.dataset.date=d.date;
    hm.appendChild(cell);
  });

  updateHeatmap();
}
function updateHeatmap(){
  const cells = document.querySelectorAll(".hm-cell");
  cells.forEach(cell=>{
    const date = cell.dataset.date;

    const score =
      (isMicroDone(date)?1:0) +
      (isMotivDone(date)?1:0);

    if(score===0) cell.style.background="#F2F2F2";
    if(score===1) cell.style.background="var(--sage-light)";
    if(score===2) cell.style.background="var(--sage-mid)";
  });
}

/* ==========================
      NAVIGATION
========================== */
document.querySelector("#prevBtn").addEventListener("click",()=>{
  if(index>0){
    index--;
    render();
  }
});
document.querySelector("#nextBtn").addEventListener("click",()=>{
  if(index<DAYS.length-1){
    index++;
    render();
  }
});

function render(){
  renderHeader();
  updateTabs();
  document.querySelector("#contentCard").innerHTML = buildContent();
}

/* ========================== */

</script>

</body>
</html>


