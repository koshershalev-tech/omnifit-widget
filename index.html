<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OMNIFIT Widget</title>

<style>
:root {
  --sage-light:#E6F0D8;
  --sage-mid:#BFD4A5;
  --sage-dark:#8BB076;
  --card:#FFFFFF;
  --muted:#475569;
  --ink:#111;
  --border:#DCE7FF;
  --frame-bg:#E8E6E6;
}

html, body {
  margin:0; padding:0;
  background:var(--frame-bg);
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
}
body {
  display:flex;
  justify-content:center;
  padding:20px;
}

/* MAIN CARD */
#wrap {
  width:100%;
  max-width:420px;
  background:var(--card);
  border-radius:24px;
  padding:32px 20px;
  box-shadow:0 4px 24px rgba(44,62,80,0.08);
  box-sizing:border-box;
}

/* NAV BUTTONS */
.header-nav {
  display:flex;
  justify-content:center;
  gap:24px;
  margin-bottom:12px;
}
.nav-btn {
  width:36px;
  height:36px;
  border-radius:10px;
  border:1.5px solid var(--border);
  background:white;
  font-size:18px;
  cursor:pointer;
  transition:0.2s;
}

/* TITLE */
#headerTitle {
  text-align:center;
  font-size:20px;
  font-weight:700;
  margin-bottom:16px;
  color:var(--ink);
}

/* HEATMAP */
#heatmapContainer {
  margin-bottom:18px;
}

.hm-month-label {
  text-align:center;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
  font-weight:600;
}

.hm-row {
  display:flex;
  align-items:center;
  gap:2px; /* compact for perfect width fill */
  margin-bottom:4px;
}

.hm-label {
  width:28px;
  text-align:right;
  font-size:12px;
  color:var(--muted);
  margin-right:2px;
}

.hm-cell {
  width:12px;
  height:12px;
  background:#F2F2F2;
  border-radius:4px;
}

/* TABS */
#tabs {
  display:flex;
  margin-bottom:16px;
}

.tab {
  flex:1;
  text-align:center;
  padding:8px 6px;
  margin:0 4px;
  border-radius:999px;
  border:1.5px solid var(--border);
  background:white;
  color:var(--muted);
  cursor:pointer;
  font-weight:600;
  transition:0.2s;
}
.tab.active {
  background:var(--sage-light);
  border-color:var(--sage-light);
  color:var(--ink);
}

/* CONTENT CARD */
#contentCard {
  background:white;
  border-radius:18px;
  border:1.5px solid #E0E6E2;
  padding:18px;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);
  position:relative;
  max-height:60vh;
  overflow-y:auto;
}

/* CHECKMARK */
.checkmark {
  position:absolute;
  right:16px;
  bottom:16px;
  width:26px;
  height:26px;
  border-radius:10px;
  border:2px solid var(--border);
  background:white;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
}
.checkmark.checked {
  background:var(--sage-light);
  border-color:var(--sage-dark);
}
.checkmark.checked::after {
  content:"✓";
  font-weight:700;
  color:var(--sage-dark);
}
</style>
</head>

<body>

<div id="wrap">

  <!-- NAV -->
  <div class="header-nav">
    <button id="prevBtn" class="nav-btn">←</button>
    <button id="nextBtn" class="nav-btn">→</button>
  </div>

  <!-- TITLE -->
  <div id="headerTitle">Loading…</div>

  <!-- HEATMAP -->
  <div id="heatmapContainer"></div>

  <!-- TABS -->
  <div id="tabs">
    <div class="tab active" data-tab="micro">Micro Exercise</div>
    <div class="tab" data-tab="motivation">Motivation</div>
  </div>

  <!-- CONTENT -->
  <div id="contentCard"></div>

</div>

<script>
/* ------------------------------
      CONFIG & STATE
--------------------------------*/
const JSON_URL="./omnifit_data.json";
let DAYS=[];
let index=0;
let activeTab="micro";

/* Local keys */
const KEY_MICRO=d=>`omni_micro_${d}`;
const KEY_MOTIV=d=>`omni_motiv_${d}`;

/* ------------------------------
      LOAD JSON
--------------------------------*/
fetch(JSON_URL)
.then(r=>r.json())
.then(data=>{
  DAYS=data;
  index=findTodayIndex();
  buildHeatmap();
  render();
})
.catch(err=>console.error("JSON ERROR:",err));

/* ------------------------------
      HELPERS
--------------------------------*/
function findTodayIndex(){
  const iso=new Date().toISOString().slice(0,10);
  const i=DAYS.findIndex(d=>d.date===iso);
  return i>=0?i:DAYS.length-1;
}

function calcDayNumber(dateStr){
  const epoch=new Date("2024-05-13");
  const d=new Date(dateStr);
  return Math.floor((d-epoch)/86400000)+1;
}

function formatText(t){
  if(!t) return "";
  return t.replace(/(https?:\/\/[^\s]+)/g, u =>
    `<a href="${u}" target="_blank" style="color:#2a6;text-decoration:underline;">${u}</a>`
  ).replace(/\n/g,"<br>");
}

function isMicroDone(d){ return localStorage.getItem(KEY_MICRO(d))==="1"; }
function isMotivDone(d){ return localStorage.getItem(KEY_MOTIV(d))==="1"; }

/* ------------------------------
      HEATMAP (20 columns × 4 rows)
--------------------------------*/
function buildHeatmap(){
  const wrap=document.querySelector("#heatmapContainer");
  wrap.innerHTML="";

  const COLS=20;     // ← 20 COLUMNS
  const ROWS=["Sun","Tue","Fri","Sat"];

  const monthLabel=document.createElement("div");
  monthLabel.className="hm-month-label";
  monthLabel.textContent=getMonthLabel();
  wrap.appendChild(monthLabel);

  ROWS.forEach(rowName=>{
    const row=document.createElement("div");
    row.className="hm-row";

    const label=document.createElement("div");
    label.className="hm-label";
    label.textContent=rowName;
    row.appendChild(label);

    for(let i=0;i<COLS;i++){
      const cell=document.createElement("div");
      cell.className="hm-cell";
      row.appendChild(cell);
    }

    wrap.appendChild(row);
  });

  updateHeatmap();
}

function getMonthLabel(){
  const d=DAYS[index];
  return new Date(d.date).toLocaleString("en",{month:"long"});
}

function updateHeatmap(){
  const cells=document.querySelectorAll(".hm-cell");
  const COLS=20;
  const visible=DAYS.slice(-(COLS*7));  // rolling 140 days

  cells.forEach((c,i)=>{
    const d=visible[i];
    if(!d){
      c.style.background="#F2F2F2";
      return;
    }

    const score=(isMicroDone(d.date)?1:0)+(isMotivDone(d.date)?1:0);

    if(score===0) c.style.background="#F2F2F2";
    if(score===1) c.style.background="var(--sage-light)";
    if(score===2) c.style.background="var(--sage-mid)";
  });
}

/* ------------------------------
      TABS
--------------------------------*/
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    activeTab=tab.dataset.tab;
    render();
  });
});

/* ------------------------------
      CONTENT
--------------------------------*/
function buildContent(){
  const d=DAYS[index];

  if(activeTab==="micro"){
    return `
      <h3>Micro Daily Exercise</h3>
      <div>${formatText(d.micro_exercise)}</div>
      <div class="checkmark ${isMicroDone(d.date)?"checked":""}"
           onclick="toggleMicro('${d.date}')"></div>
    `;
  }

  return `
    <h3>Motivation</h3>
    <div>${formatText(d.motivation)}</div>
    <div class="checkmark ${isMotivDone(d.date)?"checked":""}"
         onclick="toggleMotiv('${d.date}')"></div>
  `;
}

function toggleMicro(date){
  const v=!isMicroDone(date);
  localStorage.setItem(KEY_MICRO(date),v?"1":"0");
  updateHeatmap(); render();
}
function toggleMotiv(date){
  const v=!isMotivDone(date);
  localStorage.setItem(KEY_MOTIV(date),v?"1":"0");
  updateHeatmap(); render();
}

/* ------------------------------
      NAVIGATION
--------------------------------*/
document.querySelector("#prevBtn").onclick=()=>{
  if(index>0){ index--; render(); }
};
document.querySelector("#nextBtn").onclick=()=>{
  if(index<DAYS.length-1){ index++; render(); }
};

/* ------------------------------
      RENDER
--------------------------------*/
function render(){
  const d=DAYS[index];

  document.querySelector("#headerTitle").textContent =
    `Day ${calcDayNumber(d.date)} | ${d.day_type}`;

  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active",t.dataset.tab===activeTab);
  });

  document.querySelector("#contentCard").innerHTML = buildContent();
}
</script>

</body>
</html>
